---
title: 'Redis 的过期键删除'
layout: post
categories: 技术
tags:
    - Redis
---

Redis 可以通过 EXPIRE 命令或者 PEXPIRE 命令，以秒或者毫秒的精度为数据库中的某个键设置生存时间（Time To Live，TTL），在经过指定的秒数或毫秒数后，服务器会自动删除生存时间为 0 的键。

类似地，可以使用 EXPIREAT 命令或者 PEXPIREAT 命令，以秒或者毫秒的精度为数据库中的某个键设置过期时间（expire time）。过期时间是一个UNIX时间戳，当键的过期时间来临时，服务器会自动从数据库中删除这个键。

TTL 命令和 PTTL 命令接收一个带有生存时间或者过期时间的键，返回这个键的剩余生存时间，也就是，返回距离这个键被服务器自动删除还有多少时间。

PERSIST 命令可以移除一个键的过期时间。

## 过期时间的保存

Redis将过期时间保存在redisDb结构中的expires字典中，称之为过期字典：

- 过期字典中的键是一个指针，这个指针指向键空间中的某个键对象，即某个数据库键。
- 过期字典的值是一个long long类型的整数，这个整数保存了键所指向的数据库键的过期时间——一个毫秒精度的UNIX时间戳。

## 过期键的删除策略

可行的过期键删除策略有三种：

- 定时删除：在设置键的过期时间的同时，设置一个定时器，让定时器在键的过期时间来临时，立即执行对键的删除操作。
- 惰性删除：放任键过期时间不管，但是每次从键控件中获取键时，都检查取得的键是否过期，如果过期的话，就删除该键；如果没有过期，就返回该键。
- 定期删除：每隔一段时间，程序就对数据库进行一次检查，删除里面的过期键。至于要删除多少过期键，以及要检查多少个数据库，则由算法决定。

Redis实际使用的是惰性删除和定期删除两种策略。

### 惰性删除策略的实现

所有读写数据库的Redis命令在执行前都会调用expireIfNeeded函数对输入键进行检查：

- 如果输入键已经过期，那么expireIfNeeded函数将输入键从数据库中删除。
- 如果输入键未过期，那么expireIfNeeded函数不做动作。

### 定期删除策略的实现

每当服务器周期性操作serverCron函数时，activeExpireCycle函数就会被调用，它在规定的时间内，分多次遍历服务器中的各个数据库，从数据库的expire字典中随机检查一部分键的过期时间，并删除其中的过期键。

## AOF、RDB和复制功能对过期键的处理

在执行SAVE命令或者BGSAVE命令时，程序会对数据库中的键进行检查，已过期的键不会保存到RDB文件中。

启动服务器并载入RDB文件时，如果是主服务器，那么在载入RDB文件时，已过期的键会忽略；如果是从服务器，那么载入RDB时，文件中保存的所有键，不论是否过期，都会被载入数据库中，不过主从服务器在数据同步的时候，从服务器中的数据会被清空，所以一般不会造成影响。

当服务器以AOF持久化模式运行时，如果某个键过期，但还没有被惰性删除或定期删除，那么不会对AOF文件产生任何影响。当某个键被惰性删除或定期删除后，程序会向AOF文件追加一条DEL命令，来显式地记录该键已被删除。

AOF重写时同样会对键检查，已过期的键不会写入新的AOF文件中。

当服务器运行在复制模式下，从服务器的过期键删除动作由主服务器控制：

- 主服务器在删除一个过期键后，会显式地向所有从服务器发送一个DEL命令，告知从服务器删除这个过期键。
- ** 从服务器在执行客户端发送的读命令时，即使碰到过期键也不会将过期键删除，而是继续像处理未过期的键一样来处理过期键 **。
- 从服务器只有在接收到主服务器发送的DEL命令后，才会删除过期键。

通过由主服务器来控制从服务器统一地删除过期键，可以保证主从服务器的数据一致性，也正是因为这个原因， ** 当一个过期键仍然存在于主服务器的数据库时，这个过期键在从服务器里的复制品也会继续存在 **。